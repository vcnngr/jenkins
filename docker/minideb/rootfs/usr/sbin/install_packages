#!/bin/bash
################################################################################
# VCNNGR install_packages utility
#
# Wrapper intelligente per apt-get che:
# - Aggiorna cache se necessario
# - Installa pacchetti con opzioni ottimali
# - Pulisce automaticamente
# - Gestisce errori gracefully
#
# Copyright (c) 2025 VCNNGR
# SPDX-License-Identifier: MIT
#
# Posizione: docker/minideb/rootfs/usr/sbin/install_packages
# Usage: install_packages package1 package2 package3 ...
################################################################################

set -e
set -u
set -o pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Functions
log() {
    echo -e "${GREEN}[install_packages]${NC} $*"
}

error() {
    echo -e "${RED}[install_packages ERROR]${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}[install_packages WARN]${NC} $*"
}

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    error "This script must be run as root"
    exit 1
fi

# Check if packages were provided
if [[ $# -eq 0 ]]; then
    error "No packages specified"
    echo "Usage: install_packages package1 package2 ..."
    exit 1
fi

# Check if apt lists need update (older than 1 day)
LISTS_DIR="/var/lib/apt/lists"
if [[ ! -d "$LISTS_DIR" ]] || [[ -z "$(find "$LISTS_DIR" -maxdepth 0 -mtime -1 2>/dev/null)" ]]; then
    log "Updating apt cache..."
    apt-get update -qq
else
    log "Apt cache is recent, skipping update"
fi

# Install packages
log "Installing packages: $*"

DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    -o Dpkg::Options::="--force-confdef" \
    -o Dpkg::Options::="--force-confold" \
    "$@" || {
    error "Failed to install packages"
    exit 1
}

# Clean up
log "Cleaning up..."
apt-get clean
rm -rf \
    /var/lib/apt/lists/* \
    /tmp/* \
    /var/tmp/* \
    /var/cache/apt/archives/*.deb \
    /var/cache/apt/archives/partial/*.deb \
    /var/cache/apt/*.bin

log "Successfully installed packages: $*"
